version: 2.1

orbs:
  node: circleci/node@5.0.2

executors:
  clever-cloud-deployer:
    docker:
      - image: cimg/node:lts
  app-builder:
    docker:
      - image: cimg/node:10.24.1

jobs:
  server-lint:
    executor: app-builder
    steps:
      - checkout
      - node/install-packages:
          app-dir: server
      - run:
          command: npm run lint
          working_directory: server
      - run:
          command: npm run prettier:check
          working_directory: server

  client-lint:
    executor: app-builder
    steps:
      - checkout
      - node/install-packages:
          app-dir: client
      - run:
          command: npm run lint
          working_directory: client
      - run:
          command: npm run prettier:check
          working_directory: client

  client-build:
    executor: app-builder
    steps:
      - checkout
      - node/install-packages:
          app-dir: client
      - run:
          command: npm run build
          working_directory: client
      - persist_to_workspace:
          root: .
          paths:
            - client/build/

  prisma-deploy:
    parameters:
      clever-app-id:
        type: string
      deploy-dir:
        type: string
        default: ~/prisma_deploy
    executor: clever-cloud-deployer
    steps:
      - checkout
      - attach_workspace:
          at: .
      - run:
          name: Package application
          command: |
            mkdir -p << parameters.deploy-dir >>
            cp server/prisma/Dockerfile.clever-cloud << parameters.deploy-dir >>/Dockerfile
            cd << parameters.deploy-dir >>
            git config --global user.email "dsi-ext@zenika.com"
            git config --global user.name "Zenika"
            git init
            git add .
            git commit -m "deploy!"
      - run:
          name: Deploy to Clever Cloud
          working_directory: << parameters.deploy-dir >>
          command: |
            npm install --global clever-tools
            clever login --secret=$CLEVER_SECRET --token=$CLEVER_TOKEN
            clever link << parameters.clever-app-id >>
            clever deploy --force

  app-deploy:
    parameters:
      clever-app-id:
        type: string
      deploy-dir:
        type: string
        default: ~/deploy
    executor: clever-cloud-deployer
    steps:
      - checkout
      - attach_workspace:
          at: .
      - run:
          name: Package application
          command: |
            mkdir -p << parameters.deploy-dir >>
            cp -R server/* << parameters.deploy-dir >>/
            cp -R client/build/ << parameters.deploy-dir >>/front_build
            cd << parameters.deploy-dir >>
            cp prisma/prisma.yml scripts/prisma_deploy_all/
            cp prisma/datamodel.graphql scripts/prisma_deploy_all/
            git config --global user.email "dsi-ext@zenika.com"
            git config --global user.name "Zenika"
            git init
            git add .
            git commit -m "deploy!"
      - run:
          name: Deploy to Clever Cloud
          working_directory: << parameters.deploy-dir >>
          command: |
            npm install --global clever-tools
            clever login --secret=$CLEVER_SECRET --token=$CLEVER_TOKEN
            clever link << parameters.clever-app-id >>
            clever deploy --force

workflows:
  version: 2
  build-deploy:
    jobs:
      - server-lint
      - client-lint
      - client-build
      - app-deploy:
          clever-app-id: app_c61407ae-b417-4406-86ed-cfd1acf84466
          context: clever-cloud-deployment
          requires:
            - server-lint
            - client-lint
            - client-build
          filters:
            branches:
              only: upgrade_prisma
      - prisma-deploy:
          clever-app-id: app_f9c5c1cb-fe9c-41f9-a6c0-793e8326e95b
          context: clever-cloud-deployment
          requires:
            - app-deploy
