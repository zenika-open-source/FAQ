version: 2.1

orbs:
  node: circleci/node@5.0.2

executors:
  clever-cloud-deployer:
    docker:
      - image: cimg/node:lts
  app-builder:
    docker:
      - image: cimg/node:16.15

jobs:
  server-lint:
    executor: app-builder
    steps:
      - checkout
      - node/install-packages:
          app-dir: server
      - run:
          command: npm run lint
          working_directory: server
      - run:
          command: npm run prettier:check
          working_directory: server

  client-lint:
    executor: app-builder
    steps:
      - checkout
      - node/install-packages:
          app-dir: client
      - run:
          command: npm run lint
          working_directory: client
      - run:
          command: npm run prettier:check
          working_directory: client

  test:
    executor: app-builder
    steps:
      - checkout
      - setup_remote_docker
      - node/install-packages:
          app-dir: e2e
      - node/install-packages:
          app-dir: server
      - node/install-packages:
          app-dir: client
      - run:
          command: npm install -g wait-on
      - run:
          command: npm start
          working_directory: client
          background: true
      - run:
          command: npm start
          working_directory: server
          background: true
      - run:
          command: npm run local_containers
          working_directory: server
          background: true
      - run: ./server/scripts/wait-for-it/wait-for-it.sh -t 60 localhost:4466
      - run:
          command: npm run new_service default/default
          working_directory: server
          environment:
            PRISMA_URL: http://localhost:4466
            PRISMA_API_SECRET: secret-42
            PRISMA_MANAGEMENT_API_SECRET: my-secret-42
            AUTH0_DOMAIN: auth0Domain
            AUTH0_CLIENT_ID: auth0ClientId
      - run: wait-on http://localhost:3000
      - run:
          command: npm run test
          working_directory: e2e
          when: on_success
          environment:
            PRISMA_URL: http://localhost:4466
            PRISMA_API_SECRET: secret-42
            PRISMA_MANAGEMENT_API_SECRET: my-secret-42
            SERVICE_NAME: default
            SERVICE_STAGE: default

  client-build:
    executor: app-builder
    steps:
      - checkout
      - node/install-packages:
          app-dir: client
      - run:
          command: npm run build
          working_directory: client
      - persist_to_workspace:
          root: .
          paths:
            - client/build/

  prisma-deploy:
    parameters:
      clever-app-id:
        type: string
      deploy-dir:
        type: string
        default: ~/prisma_deploy
    executor: clever-cloud-deployer
    steps:
      - checkout
      - attach_workspace:
          at: .
      - run:
          name: Package application
          command: |
            mkdir -p << parameters.deploy-dir >>
            cp server/prisma/Dockerfile.clever-cloud << parameters.deploy-dir >>/Dockerfile
            cd << parameters.deploy-dir >>
            git config --global user.email "dsi-ext@zenika.com"
            git config --global user.name "Zenika"
            git init
            git add .
            git commit -m "deploy!"
      - run:
          name: Deploy to Clever Cloud
          working_directory: << parameters.deploy-dir >>
          command: |
            sudo npm install --global clever-tools
            clever login --secret=$CLEVER_SECRET --token=$CLEVER_TOKEN
            clever link << parameters.clever-app-id >>
            clever deploy --force

  app-deploy:
    parameters:
      clever-app-id:
        type: string
      deploy-dir:
        type: string
        default: ~/deploy
    executor: clever-cloud-deployer
    steps:
      - checkout
      - attach_workspace:
          at: .
      - run:
          name: Package application
          command: |
            mkdir -p << parameters.deploy-dir >>
            cp -R server/* << parameters.deploy-dir >>/
            cp -R client/build/ << parameters.deploy-dir >>/front_build
            cd << parameters.deploy-dir >>
            cp prisma/prisma.yml scripts/prisma_deploy_all/
            cp prisma/datamodel.graphql scripts/prisma_deploy_all/
            git config --global user.email "dsi-ext@zenika.com"
            git config --global user.name "Zenika"
            git init
            git add .
            git commit -m "deploy!"
      - run:
          name: Deploy to Clever Cloud
          working_directory: << parameters.deploy-dir >>
          command: |
            sudo npm install --global clever-tools
            clever login --secret=$CLEVER_SECRET --token=$CLEVER_TOKEN
            clever link << parameters.clever-app-id >>
            clever deploy --force

workflows:
  version: 2
  build-deploy:
    jobs:
      - server-lint
      - client-lint
      - test
      - client-build
      - app-deploy:
          clever-app-id: app_c61407ae-b417-4406-86ed-cfd1acf84466
          context: clever-cloud-deployment
          requires:
            - server-lint
            - client-lint
            - client-build
          filters:
            branches:
              only: main
      - prisma-deploy:
          clever-app-id: app_f9c5c1cb-fe9c-41f9-a6c0-793e8326e95b
          context: clever-cloud-deployment
          requires:
            - app-deploy
