version: 2.1

orbs:
  node: circleci/node@5.0.2

executors:
  clever-cloud-deployer:
    docker:
      - image: cimg/node:lts
  app-builder:
    docker:
      - image: cimg/node:10.24.1

jobs:
  server-lint:
    executor: app-builder
    steps:
      - checkout
      - node/install-packages:
          app-dir: server
      - run:
          command: npm run lint
          working_directory: server
      - run:
          command: npm run prettier:check
          working_directory: server

  client-lint:
    executor: app-builder
    steps:
      - checkout
      - node/install-packages:
          app-dir: client
      - run:
          command: npm run lint
          working_directory: client
      - run:
          command: npm run prettier:check
          working_directory: client

  client-build:
    executor: app-builder
    steps:
      - checkout
      - node/install-packages:
          app-dir: client
      - run:
          command: npm run build
          working_directory: client
      - persist_to_workspace:
          root: .
          paths:
            - client/build/

  prisma-deploy:
    environment:
      DEPLOY_DIR: ~/prisma_deploy
      CLEVER_CLOUD_REMOTE_HOST: push-par-clevercloud-customers.services.clever-cloud.com
      CLEVER_CLOUD_REMOTE_APP_ID: app_f9c5c1cb-fe9c-41f9-a6c0-793e8326e95b
    executor: clever-cloud-deployer
    steps:
      - checkout
      - attach_workspace:
          at: .

      - add_ssh_keys:
          fingerprints:
            - "6f:f2:b4:c2:e5:13:28:f8:02:2d:da:48:34:0c:14:7f"

      - run: |
          mkdir -p ~/.ssh
          ssh-keyscan ${CLEVER_CLOUD_REMOTE_HOST} >> ~/.ssh/known_hosts
          mkdir -p ${DEPLOY_DIR}
          cp server/prisma/Dockerfile.clever-cloud ${DEPLOY_DIR}/Dockerfile
          cd ${DEPLOY_DIR}
          git init
          git config user.email "dsi-ext@zenika"
          git config user.name "DSI Ext"
          git add .
          git commit -m "Deploy"
          git remote add clever git+ssh://git@${CLEVER_CLOUD_REMOTE_HOST}/${CLEVER_CLOUD_REMOTE_APP_ID}.git
          git push --force clever master

  app-deploy:
    environment:
      DEPLOY_DIR: ~/deploy
      CLEVER_CLOUD_REMOTE_HOST: push-par-clevercloud-customers.services.clever-cloud.com
      CLEVER_CLOUD_REMOTE_APP_ID: app_c61407ae-b417-4406-86ed-cfd1acf84466
    executor: clever-cloud-deployer
    steps:
      - checkout
      - attach_workspace:
          at: .

      - add_ssh_keys:
          fingerprints:
            - "6f:f2:b4:c2:e5:13:28:f8:02:2d:da:48:34:0c:14:7f"

      - run: |
          mkdir -p ~/.ssh
          ssh-keyscan ${CLEVER_CLOUD_REMOTE_HOST} >> ~/.ssh/known_hosts
          mkdir -p ${DEPLOY_DIR}
          cp -R server/* ${DEPLOY_DIR}/
          cp -R client/build/ ${DEPLOY_DIR}/front_build
          cd ${DEPLOY_DIR}
          cp prisma/prisma.yml scripts/prisma_deploy_all/
          cp prisma/datamodel.graphql scripts/prisma_deploy_all/
          git init
          git config user.email "dsi-ext@zenika.com"
          git config user.name "DSI Ext"
          echo "node_modules/" > .gitignore
          git add .gitignore
          git add -A
          git commit -m "Deploy"
          git remote add clever git+ssh://git@${CLEVER_CLOUD_REMOTE_HOST}/${CLEVER_CLOUD_REMOTE_APP_ID}.git
          git push --force clever master
          npm run deploy

workflows:
  version: 2
  build-deploy:
    jobs:
      - server-lint
      - client-lint
      - client-build
      - app-deploy:
          requires:
            - server-lint
            - client-lint
            - client-build
          filters:
            branches:
              only: master
      - prisma-deploy:
          requires:
            - app-deploy
          filters:
            branches:
              only: master
